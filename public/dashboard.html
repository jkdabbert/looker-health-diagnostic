<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Looker Health Diagnostic Assistant</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createRoot } = ReactDOM;

        // Simple icon components
        const Activity = ({ className }) => <div className={`${className} flex items-center justify-center`}>📊</div>;
        const AlertTriangle = ({ className }) => <div className={`${className} flex items-center justify-center`}>⚠️</div>;
        const CheckCircle = ({ className }) => <div className={`${className} flex items-center justify-center`}>✅</div>;
        const Clock = ({ className }) => <div className={`${className} flex items-center justify-center`}>⏰</div>;
        const Database = ({ className }) => <div className={`${className} flex items-center justify-center`}>🗄️</div>;
        const TrendingUp = ({ className }) => <div className={`${className} flex items-center justify-center`}>📈</div>;
        const Users = ({ className }) => <div className={`${className} flex items-center justify-center`}>👥</div>;
        const Zap = ({ className }) => <div className={`${className} flex items-center justify-center`}>⚡</div>;
        const Target = ({ className }) => <div className={`${className} flex items-center justify-center`}>🎯</div>;
        const BookOpen = ({ className }) => <div className={`${className} flex items-center justify-center`}>📖</div>;
        const Shield = ({ className }) => <div className={`${className} flex items-center justify-center`}>🛡️</div>;
        const Code = ({ className }) => <div className={`${className} flex items-center justify-center`}>💻</div>;
        const Settings = ({ className }) => <div className={`${className} flex items-center justify-center`}>🔧</div>;
        const Search = ({ className }) => <div className={`${className} flex items-center justify-center`}>🔍</div>;
        const Brain = ({ className }) => <div className={`${className} flex items-center justify-center`}>🤖</div>;

        // Enhanced SQL Comparison Card Component
        const SQLComparisonCard = ({ analysis }) => {
          const [activeTab, setActiveTab] = useState('issues');

          const getSeverityColor = (severity) => {
            switch (severity) {
              case 'critical': return 'bg-red-100 text-red-800 border-red-200';
              case 'high': return 'bg-red-100 text-red-800 border-red-200';
              case 'medium': return 'bg-yellow-100 text-yellow-800 border-yellow-200';
              case 'low': return 'bg-blue-100 text-blue-800 border-blue-200';
              default: return 'bg-gray-100 text-gray-800 border-gray-200';
            }
          };

          const generateOptimizedSQL = (originalSQL, recommendations) => {
            let optimized = originalSQL || 'SQL not available';
            let comments = [];

            if (recommendations && recommendations.length > 0) {
              recommendations.forEach((rec, index) => {
                if (rec.type === 'pdt_creation' || rec.title?.includes('PDT')) {
                  comments.push(`-- OPTIMIZATION ${index + 1}: ${rec.title || 'Create PDT'}`);
                  comments.push(`-- Expected improvement: ${rec.expectedImprovement || '70-85%'}`);
                  comments.push(`-- Implementation: Create PDT view for this query pattern`);
                }
                
                if (rec.action && rec.action.toLowerCase().includes('index')) {
                  comments.push(`-- OPTIMIZATION ${index + 1}: Add database indexes`);
                  comments.push(`-- ${rec.action}`);
                }

                if (rec.action && rec.action.toLowerCase().includes('select')) {
                  comments.push(`-- OPTIMIZATION ${index + 1}: Optimize SELECT clause`);
                  optimized = optimized.replace(/SELECT\s+\*/gi, 'SELECT\n  -- Specify only required columns instead of *\n  t.id, t.name, t.created_date');
                }
              });
            }

            // Add WHERE clause optimization if missing
            if (!optimized.toLowerCase().includes('where') && optimized.toLowerCase().includes('from')) {
              const fromIndex = optimized.toLowerCase().indexOf('from');
              const afterFrom = optimized.substring(fromIndex);
              const nextClause = afterFrom.match(/(group by|order by|limit)/i);
              
              if (nextClause) {
                const insertPoint = fromIndex + afterFrom.indexOf(nextClause[0]);
                optimized = optimized.substring(0, insertPoint) + 
                           '\nWHERE\n  -- Add filtering conditions to reduce data scanned\n  created_date >= CURRENT_DATE - INTERVAL 30 DAY\n  AND status = \'active\'\n' + 
                           optimized.substring(insertPoint);
                comments.push('-- OPTIMIZATION: Added WHERE clause to limit data scanning');
              }
            }

            return {
              sql: comments.length > 0 ? comments.join('\n') + '\n\n' + optimized : optimized,
              optimizations: comments
            };
          };

          const generatePDTCode = (analysis) => {
            const modelName = analysis.model || 'your_model';
            const exploreName = analysis.explore || 'your_explore';
            
            return `view: ${exploreName}_optimized_pdt {
  derived_table: {
    sql: 
      SELECT 
        DATE_TRUNC('day', created_at) as date_day,
        user_id,
        category,
        COUNT(*) as event_count,
        SUM(amount) as total_amount,
        AVG(amount) as avg_amount
      FROM \${${exploreName}.SQL_TABLE_NAME}
      WHERE created_at >= CURRENT_DATE - INTERVAL 90 DAY
        AND status = 'complete'
      GROUP BY 1, 2, 3 ;;
    
    datagroup_trigger: ${modelName}_default_datagroup
    distribution_style: even
    sortkeys: ["date_day"]
    
    # This PDT reduces query time from ${analysis.runtime}s to ~2-5s
    # Expected improvement: 85-95%
  }
  
  dimension: date_day {
    type: date
    sql: \${TABLE}.date_day ;;
  }
  
  dimension: user_id {
    type: string
    sql: \${TABLE}.user_id ;;
  }
  
  dimension: category {
    type: string
    sql: \${TABLE}.category ;;
  }
  
  measure: total_events {
    type: sum
    sql: \${TABLE}.event_count ;;
    label: "Total Events"
  }
  
  measure: total_amount {
    type: sum
    sql: \${TABLE}.total_amount ;;
    value_format_name: usd
  }
  
  measure: average_amount {
    type: average
    sql: \${TABLE}.avg_amount ;;
    value_format_name: usd
  }
}`;
          };

          const optimizedSQLResult = analysis.analysis?.recommendations ? 
            generateOptimizedSQL(analysis.originalSQL || analysis.sql, analysis.analysis.recommendations) : null;

          return (
            <div className="bg-white rounded-lg shadow-lg border border-gray-200 mb-6">
              {/* Header */}
              <div className="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-blue-50">
                <div className="flex items-center justify-between">
                  <h4 className="text-lg font-semibold text-gray-800 flex items-center space-x-2">
                    <Brain className="w-5 h-5 text-purple-600" />
                    <span>AI Analysis: {analysis.slug || analysis.queryId}</span>
                  </h4>
                  <div className="flex items-center space-x-2">
                    <span className="bg-red-100 text-red-800 text-sm px-3 py-1 rounded-full font-medium">
                      {analysis.runtime}s runtime
                    </span>
                    {analysis.overallPriority && (
                      <span className={`text-sm px-3 py-1 rounded-full font-medium ${getSeverityColor(analysis.overallPriority)}`}>
                        {analysis.overallPriority} priority
                      </span>
                    )}
                  </div>
                </div>
                <div className="text-sm text-gray-600 mt-1">
                  {analysis.model}.{analysis.explore} • {analysis.dashboard || 'No dashboard'}
                </div>
              </div>

              {/* Tab Navigation */}
              <div className="border-b border-gray-200">
                <nav className="flex space-x-8 px-6">
                  {[
                    { id: 'issues', label: '🚨 Issues' },
                    { id: 'recommendations', label: '💡 Recommendations' },
                    { id: 'sql-comparison', label: '⚡ SQL Optimization' },
                    { id: 'lookml', label: '🏗️ LookML Code' }
                  ].map((tab) => (
                    <button
                      key={tab.id}
                      onClick={() => setActiveTab(tab.id)}
                      className={`py-4 border-b-2 font-medium text-sm ${
                        activeTab === tab.id
                          ? 'border-purple-500 text-purple-600'
                          : 'border-transparent text-gray-500 hover:text-gray-700'
                      }`}
                    >
                      {tab.label}
                    </button>
                  ))}
                </nav>
              </div>

              {/* Tab Content */}
              <div className="p-6">
                {activeTab === 'issues' && (
                  <div className="space-y-3">
                    <h5 className="font-medium text-gray-700 mb-3">Issues Identified:</h5>
                    {analysis.analysis?.issues && analysis.analysis.issues.length > 0 ? (
                      analysis.analysis.issues.map((issue, i) => (
                        <div key={i} className={`p-4 rounded-lg border ${getSeverityColor(issue.severity)}`}>
                          <div className="font-medium mb-1">
                            {issue.type?.replace(/_/g, ' ').toUpperCase()}: {issue.severity?.toUpperCase()}
                          </div>
                          <div className="text-sm mb-2">{issue.description || issue.issue}</div>
                          <div className="text-sm font-medium">
                            💡 Fix: {issue.recommendation}
                          </div>
                        </div>
                      ))
                    ) : (
                      <div className="text-gray-500 text-center py-4">No specific issues identified by AI</div>
                    )}
                  </div>
                )}

                {activeTab === 'recommendations' && (
                  <div className="space-y-3">
                    <h5 className="font-medium text-gray-700 mb-3">Optimization Recommendations:</h5>
                    {analysis.analysis?.recommendations && analysis.analysis.recommendations.length > 0 ? (
                      analysis.analysis.recommendations.map((rec, i) => (
                        <div key={i} className="p-4 bg-green-50 rounded-lg border border-green-200">
                          <div className="font-medium text-green-800 mb-1">
                            {rec.title || rec.action || rec.recommendation}
                          </div>
                          {rec.expectedImprovement && (
                            <div className="text-sm text-green-700 mb-2">
                              Expected improvement: {rec.expectedImprovement}
                            </div>
                          )}
                          {rec.effort && (
                            <div className="text-sm text-green-600">
                              Implementation effort: {rec.effort}
                            </div>
                          )}
                        </div>
                      ))
                    ) : (
                      <div className="text-gray-500 text-center py-4">No specific recommendations available</div>
                    )}
                  </div>
                )}

                {activeTab === 'sql-comparison' && (
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <h5 className="font-medium text-gray-700">SQL Optimization Comparison</h5>
                      <div className="text-sm text-gray-500">
                        Runtime: {analysis.runtime}s → Estimated: 2-5s
                      </div>
                    </div>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                      {/* Original SQL */}
                      <div className="border rounded-lg overflow-hidden">
                        <div className="bg-red-50 px-4 py-2 border-b border-red-200">
                          <h6 className="font-medium text-red-800">🐌 Original SQL ({analysis.runtime}s)</h6>
                        </div>
                        <div className="bg-gray-50 p-4 max-h-80 overflow-y-auto">
                          <pre className="text-sm text-gray-800 whitespace-pre-wrap">
                            {analysis.originalSQL || analysis.sql || 'SQL not available'}
                          </pre>
                        </div>
                      </div>

                      {/* Optimized SQL */}
                      <div className="border rounded-lg overflow-hidden">
                        <div className="bg-green-50 px-4 py-2 border-b border-green-200">
                          <h6 className="font-medium text-green-800">⚡ Optimized SQL (Est. 2-5s)</h6>
                        </div>
                        <div className="bg-gray-50 p-4 max-h-80 overflow-y-auto">
                          <pre className="text-sm text-gray-800 whitespace-pre-wrap">
                            {optimizedSQLResult?.sql || 'Optimization suggestions applied above'}
                          </pre>
                        </div>
                      </div>
                    </div>

                    {/* Key Optimizations */}
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                      <h6 className="font-medium text-blue-800 mb-2">🔧 Key Optimizations Applied:</h6>
                      <ul className="text-sm text-blue-700 space-y-1">
                        <li>• Replace SELECT * with specific columns</li>
                        <li>• Add WHERE clause to limit data scanning</li>
                        <li>• Consider PDT implementation for repeated patterns</li>
                        <li>• Add appropriate indexes for JOIN columns</li>
                        {optimizedSQLResult?.optimizations.map((opt, i) => (
                          <li key={i}>• {opt.replace('--', '').trim()}</li>
                        ))}
                      </ul>
                    </div>
                  </div>
                )}

                {activeTab === 'lookml' && (
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <h5 className="font-medium text-gray-700">Recommended PDT Implementation</h5>
                      <span className="text-sm bg-purple-100 text-purple-800 px-2 py-1 rounded">
                        85-95% faster
                      </span>
                    </div>
                    
                    <div className="bg-gray-800 rounded-lg overflow-hidden">
                      <div className="bg-gray-700 px-4 py-2">
                        <div className="text-white text-sm font-medium">
                          📄 {analysis.explore || 'optimized'}_pdt.view.lkml
                        </div>
                      </div>
                      <div className="p-4 max-h-96 overflow-y-auto">
                        <pre className="text-green-400 text-sm whitespace-pre-wrap">
                          {generatePDTCode(analysis)}
                        </pre>
                      </div>
                    </div>

                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                      <h6 className="font-medium text-yellow-800 mb-2">📋 Implementation Steps:</h6>
                      <ol className="text-sm text-yellow-700 space-y-1 list-decimal list-inside">
                        <li>Create the PDT view file above in your LookML project</li>
                        <li>Add appropriate datagroup triggers for refresh timing</li>
                        <li>Update your explore to use the PDT as the base</li>
                        <li>Deploy and test the optimized performance</li>
                        <li>Monitor query performance improvements</li>
                      </ol>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        };

        // Two-Phase Diagnostic Tab Component
        const TwoPhaseDiagnosticTab = () => {
          const [scanResults, setScanResults] = useState(null);
          const [selectedQueries, setSelectedQueries] = useState(new Set());
          const [phase1Loading, setPhase1Loading] = useState(false);
          const [phase2Loading, setPhase2Loading] = useState(false);
          const [aiAnalysisResults, setAiAnalysisResults] = useState([]);
          const [error, setError] = useState(null);

          const runFastScan = async () => {
            setPhase1Loading(true);
            setError(null);
            setScanResults(null);
            setAiAnalysisResults([]);
            
            try {
              const response = await fetch('/api/diagnostic/scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
              });
              
              const data = await response.json();
              
              if (response.ok) {
                setScanResults(data);
              } else {
                setError(data.error || 'Fast scan failed');
              }
            } catch (error) {
              setError(error.message);
            } finally {
              setPhase1Loading(false);
            }
          };

          const toggleQuery = (queryId) => {
            const newSelected = new Set(selectedQueries);
            if (newSelected.has(queryId)) {
              newSelected.delete(queryId);
            } else {
              newSelected.add(queryId);
            }
            setSelectedQueries(newSelected);
          };

          const selectTop = (n) => {
            if (!scanResults) return;
            const topQueries = scanResults.slowQuerySummary.queries
              .sort((a, b) => b.runtime_seconds - a.runtime_seconds)
              .slice(0, n);
            setSelectedQueries(new Set(topQueries.map(q => q.query_id)));
          };

          const analyzeSelectedQueries = async () => {
            if (!scanResults || selectedQueries.size === 0) return;
            
            setPhase2Loading(true);
            const queries = scanResults.slowQuerySummary.queries
              .filter(q => selectedQueries.has(q.query_id));
            
            try {
              const response = await fetch('/api/diagnostic/analyze-batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ queries, maxQueries: 10 })
              });
              
              const data = await response.json();
              
              if (response.ok) {
                setAiAnalysisResults(data.analyses || []);
              } else {
                setError(data.error || 'AI analysis failed');
              }
            } catch (error) {
              setError(error.message);
            } finally {
              setPhase2Loading(false);
            }
          };

          const getSeverityColor = (severity) => {
            switch (severity) {
              case 'critical': return 'bg-red-100 text-red-800';
              case 'high': return 'bg-red-100 text-red-800';
              case 'medium': return 'bg-yellow-100 text-yellow-800';
              case 'low': return 'bg-blue-100 text-blue-800';
              default: return 'bg-gray-100 text-gray-800';
            }
          };

          const getRuntimeColor = (category) => {
            switch (category) {
              case 'critical': return 'text-red-600 bg-red-50';
              case 'high': return 'text-orange-600 bg-orange-50';
              case 'medium': return 'text-yellow-600 bg-yellow-50';
              default: return 'text-green-600 bg-green-50';
            }
          };

          return (
            <div className="space-y-6">
              {/* Phase 1: Fast Scan */}
              <div className="bg-white rounded-lg shadow">
                <div className="px-6 py-4 border-b border-gray-200">
                  <div className="flex items-center space-x-3">
                    <div className="bg-blue-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">1</div>
                    <div>
                      <h3 className="text-lg font-semibold text-gray-800">Fast Performance Scan</h3>
                      <p className="text-sm text-gray-600">Quickly identify slow queries and performance issues (30-60 seconds)</p>
                    </div>
                  </div>
                </div>
                
                <div className="p-6">
                  <button
                    onClick={runFastScan}
                    disabled={phase1Loading}
                    className="bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center space-x-2"
                  >
                    {phase1Loading ? (
                      <>
                        <div className="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full" />
                        <span>Scanning...</span>
                      </>
                    ) : (
                      <>
                        <Search className="w-4 h-4" />
                        <span>Run Fast Scan</span>
                      </>
                    )}
                  </button>

                  {/* Phase 1 Results */}
                  {scanResults && (
                    <div className="mt-6 space-y-4">
                      {/* Summary Cards */}
                      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div className="bg-gray-50 p-4 rounded-lg text-center">
                          <div className={`text-3xl font-bold mb-1`}>
                            {scanResults.overallGrade}
                          </div>
                          <div className="text-sm text-gray-600">Overall Grade</div>
                        </div>
                        <div className="bg-red-50 p-4 rounded-lg text-center">
                          <div className="text-3xl font-bold text-red-600 mb-1">
                            {scanResults.slowQuerySummary.totalSlowQueries}
                          </div>
                          <div className="text-sm text-gray-600">Slow Queries</div>
                        </div>
                        <div className="bg-orange-50 p-4 rounded-lg text-center">
                          <div className="text-3xl font-bold text-orange-600 mb-1">
                            {scanResults.slowQuerySummary.avgRuntime.toFixed(1)}s
                          </div>
                          <div className="text-sm text-gray-600">Avg Runtime</div>
                        </div>
                        <div className="bg-blue-50 p-4 rounded-lg text-center">
                          <div className="text-3xl font-bold text-blue-600 mb-1">
                            {Math.round(scanResults.scanDuration / 1000)}s
                          </div>
                          <div className="text-sm text-gray-600">Scan Time</div>
                        </div>
                      </div>

                      {/* Immediate Recommendations */}
                      {scanResults.recommendations?.immediate && scanResults.recommendations.immediate.length > 0 && (
                        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                          <h4 className="font-semibold text-yellow-800 mb-2">🚨 Immediate Actions Required</h4>
                          {scanResults.recommendations.immediate.map((rec, i) => (
                            <div key={i} className="mb-2 last:mb-0">
                              <div className="font-medium text-yellow-800">{rec.title}</div>
                              <div className="text-sm text-yellow-700">{rec.description}</div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>

              {/* Phase 2: AI Analysis */}
              {scanResults && (
                <div className="bg-white rounded-lg shadow">
                  <div className="px-6 py-4 border-b border-gray-200">
                    <div className="flex items-center space-x-3">
                      <div className="bg-purple-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">2</div>
                      <div>
                        <h3 className="text-lg font-semibold text-gray-800">AI-Powered Query Analysis</h3>
                        <p className="text-sm text-gray-600">Select specific queries for detailed AI analysis and optimization recommendations</p>
                      </div>
                    </div>
                  </div>
                  
                  <div className="p-6">
                    {/* Selection Controls */}
                    <div className="flex flex-wrap gap-2 mb-4">
                      <button
                        onClick={() => selectTop(3)}
                        className="bg-red-100 hover:bg-red-200 text-red-800 px-3 py-2 rounded text-sm transition-colors"
                      >
                        🔥 Select Top 3 Slowest
                      </button>
                      <button
                        onClick={() => selectTop(5)}
                        className="bg-orange-100 hover:bg-orange-200 text-orange-800 px-3 py-2 rounded text-sm transition-colors"
                      >
                        ⚡ Select Top 5
                      </button>
                      <button
                        onClick={() => {
                          const criticalQueries = scanResults.slowQuerySummary.queries
                            .filter(q => q.runtimeCategory === 'critical');
                          setSelectedQueries(new Set(criticalQueries.map(q => q.query_id)));
                        }}
                        className="bg-red-100 hover:bg-red-200 text-red-800 px-3 py-2 rounded text-sm transition-colors"
                      >
                        🚨 Select Critical Only
                      </button>
                      <button
                        onClick={analyzeSelectedQueries}
                        disabled={selectedQueries.size === 0 || phase2Loading}
                        className="bg-purple-600 hover:bg-purple-700 disabled:bg-purple-400 text-white px-4 py-2 rounded text-sm transition-colors flex items-center space-x-2"
                      >
                        {phase2Loading ? (
                          <>
                            <div className="animate-spin w-3 h-3 border-2 border-white border-t-transparent rounded-full" />
                            <span>Analyzing...</span>
                          </>
                        ) : (
                          <>
                            <Brain className="w-3 h-3" />
                            <span>Analyze Selected ({selectedQueries.size})</span>
                          </>
                        )}
                      </button>
                    </div>

                    {/* Query List */}
                    <div className="space-y-2 max-h-96 overflow-y-auto">
                      {scanResults.slowQuerySummary.queries
                        .sort((a, b) => b.runtime_seconds - a.runtime_seconds)
                        .map((query) => (
                        <div key={query.query_id} className="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                          <div className="flex items-center justify-between">
                            <div className="flex items-center space-x-3 flex-1">
                              <input
                                type="checkbox"
                                checked={selectedQueries.has(query.query_id)}
                                onChange={() => toggleQuery(query.query_id)}
                                className="w-4 h-4 text-purple-600 rounded focus:ring-purple-500"
                              />
                              <div className="flex-1 min-w-0">
                                <div className="font-medium text-gray-900 truncate">
                                  {query.slug || query.query_id}
                                </div>
                                <div className="text-sm text-gray-500">
                                  {query.model}.{query.explore} • {query.dashboard_title || 'No dashboard'} • {query.user_email}
                                </div>
                              </div>
                            </div>
                            <div className="flex items-center space-x-2">
                              <span className={`px-2 py-1 rounded text-sm font-medium ${getRuntimeColor(query.runtimeCategory)}`}>
                                {query.runtime_seconds.toFixed(1)}s
                              </span>
                              <span className={`px-2 py-1 rounded text-xs ${getSeverityColor(query.optimizationPriority)}`}>
                                {query.optimizationPriority}
                              </span>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}

              {/* AI Analysis Results with Enhanced SQL Comparison */}
              {aiAnalysisResults.length > 0 && (
                <div className="bg-white rounded-lg shadow">
                  <div className="px-6 py-4 border-b border-gray-200">
                    <h3 className="text-lg font-semibold text-gray-800 flex items-center space-x-2">
                      <Brain className="w-5 h-5 text-purple-600" />
                      <span>AI Analysis Results</span>
                    </h3>
                  </div>
                  
                  <div className="p-6 space-y-6">
                    {/* Summary Stats */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                      <div className="bg-purple-50 p-4 rounded-lg text-center">
                        <div className="text-2xl font-bold text-purple-600">{aiAnalysisResults.length}</div>
                        <div className="text-sm text-gray-600">Queries Analyzed</div>
                      </div>
                      <div className="bg-red-50 p-4 rounded-lg text-center">
                        <div className="text-2xl font-bold text-red-600">
                          {aiAnalysisResults.reduce((sum, a) => sum + (a.analysis?.issues?.length || 0), 0)}
                        </div>
                        <div className="text-sm text-gray-600">Issues Found</div>
                      </div>
                      <div className="bg-green-50 p-4 rounded-lg text-center">
                        <div className="text-2xl font-bold text-green-600">
                          {aiAnalysisResults.reduce((sum, a) => sum + (a.analysis?.recommendations?.length || 0), 0)}
                        </div>
                        <div className="text-sm text-gray-600">Recommendations</div>
                      </div>
                      <div className="bg-blue-50 p-4 rounded-lg text-center">
                        <div className="text-2xl font-bold text-blue-600">
                          {aiAnalysisResults.filter(a => a.overallPriority === 'critical').length}
                        </div>
                        <div className="text-sm text-gray-600">Critical Priority</div>
                      </div>
                    </div>

                    {/* Individual Query Results with SQL Comparison */}
                    {aiAnalysisResults.map((result, index) => (
                      <SQLComparisonCard key={index} analysis={result} />
                    ))}
                  </div>
                </div>
              )}

              {/* Error Display */}
              {error && (
                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                  <div className="flex items-center space-x-2">
                    <AlertTriangle className="w-5 h-5 text-red-600" />
                    <div className="font-medium text-red-800">Error</div>
                  </div>
                  <div className="text-red-700 mt-1">{error}</div>
                </div>
              )}
            </div>
          );
        };

        // API Testing Tab Component
        const APITestingTab = () => {
          const [testType, setTestType] = useState('mcp');
          const [toolName, setToolName] = useState('');
          const [apiEndpoint, setApiEndpoint] = useState('');
          const [httpMethod, setHttpMethod] = useState('GET');
          const [testArguments, setTestArguments] = useState('{}');
          const [isLoading, setIsLoading] = useState(false);
          const [response, setResponse] = useState(null);
          const [selectedTab, setSelectedTab] = useState('response');

          const predefinedTests = {
            get_models: {
              testType: 'mcp',
              toolName: 'all_lookml_models',
              arguments: '{}'
            },
            get_specific_model: {
              testType: 'mcp',
              toolName: 'looker_model',
              arguments: '{"lookml_model_name": "looker-malloy-sources"}'
            },
            slow_queries: {
              testType: 'mcp',
              toolName: 'query',
              arguments: JSON.stringify({
                model: "system__activity",
                explore: "history",
                fields: [
                  "query.id",
                  "query.slug", 
                  "history.runtime",
                  "history.created_date",
                  "query.model",
                  "query.explore"
                ],
                filters: {
                  "history.runtime": ">5",
                  "history.created_date": "7 days ago for 7 days",
                  "history.status": "complete"
                },
                sorts: ["history.runtime desc"],
                limit: 10
              }, null, 2)
            },
            test_connection: {
              testType: 'mcp',
              toolName: 'list_tools',
              arguments: '{}'
            }
          };

          const loadPredefinedTest = (testKey) => {
            const test = predefinedTests[testKey];
            if (test) {
              setTestType(test.testType);
              setToolName(test.toolName || '');
              setApiEndpoint(test.apiEndpoint || '');
              setHttpMethod(test.httpMethod || 'GET');
              setTestArguments(test.arguments);
            }
          };

          const executeTest = async () => {
            setIsLoading(true);
            setResponse(null);

            const startTime = Date.now();

            try {
              let result;
              
              if (testType === 'mcp') {
                result = await fetch('/api/test-mcp-tool', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    toolName: toolName,
                    arguments: JSON.parse(testArguments || '{}')
                  })
                });
              } else {
                result = await fetch('/api/test-api', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    endpoint: apiEndpoint,
                    method: httpMethod,
                    body: httpMethod !== 'GET' ? JSON.parse(testArguments || '{}') : null
                  })
                });
              }

              const endTime = Date.now();
              const responseData = await result.json();

              setResponse({
                success: result.ok,
                status: result.status,
                data: responseData,
                timing: {
                  duration: endTime - startTime,
                  status: result.status
                },
                request: {
                  type: testType,
                  toolName: toolName,
                  endpoint: apiEndpoint,
                  method: httpMethod,
                  arguments: testArguments
                }
              });
            } catch (error) {
              const endTime = Date.now();
              setResponse({
                success: false,
                status: 'Error',
                data: { error: error.message },
                timing: {
                  duration: endTime - startTime,
                  status: 'Failed'
                },
                request: {
                  type: testType,
                  toolName: toolName,
                  endpoint: apiEndpoint,
                  method: httpMethod,
                  arguments: testArguments
                }
              });
            } finally {
              setIsLoading(false);
            }
          };

          return (
            <div className="space-y-6">
              {/* API Testing Interface */}
              <div className="bg-white rounded-lg shadow p-6">
                <div className="flex items-center space-x-3 mb-4">
                  <Code className="w-6 h-6 text-blue-600" />
                  <div>
                    <h2 className="text-xl font-bold text-gray-800">API Testing Dashboard</h2>
                    <p className="text-sm text-gray-600">Test and debug your Looker API calls and MCP tools</p>
                  </div>
                </div>

                {/* Quick Test Buttons */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 mb-6">
                  <button
                    onClick={() => loadPredefinedTest('get_models')}
                    className="p-3 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg text-sm text-blue-800 transition-colors"
                  >
                    📋 Get All Models
                  </button>
                  <button
                    onClick={() => loadPredefinedTest('slow_queries')}
                    className="p-3 bg-red-50 hover:bg-red-100 border border-red-200 rounded-lg text-sm text-red-800 transition-colors"
                  >
                    🐌 Slow Queries
                  </button>
                  <button
                    onClick={() => loadPredefinedTest('test_connection')}
                    className="p-3 bg-orange-50 hover:bg-orange-100 border border-orange-200 rounded-lg text-sm text-orange-800 transition-colors"
                  >
                    🔧 Test Connection
                  </button>
                </div>

                {/* Test Form */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Test Type</label>
                    <select
                      value={testType}
                      onChange={(e) => setTestType(e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="mcp">MCP Tool Call</option>
                      <option value="api">Direct API Call</option>
                    </select>
                  </div>

                  {testType === 'mcp' && (
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Tool Name</label>
                      <input
                        type="text"
                        value={toolName}
                        onChange={(e) => setToolName(e.target.value)}
                        placeholder="e.g., looker_model, query, all_lookml_models"
                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                  )}
                </div>

                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">Arguments/Body (JSON)</label>
                  <textarea
                    value={testArguments}
                    onChange={(e) => setTestArguments(e.target.value)}
                    placeholder='{"lookml_model_name": "looker-malloy-sources"}'
                    rows={6}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                  />
                </div>

                <button
                  onClick={executeTest}
                  disabled={isLoading}
                  className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white px-4 py-3 rounded-lg font-medium transition-colors flex items-center justify-center space-x-2"
                >
                  {isLoading ? (
                    <>
                      <div className="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full" />
                      <span>Executing...</span>
                    </>
                  ) : (
                    <>
                      <Zap className="w-4 h-4" />
                      <span>Execute Test</span>
                    </>
                  )}
                </button>
              </div>

              {/* Response Section */}
              {response && (
                <div className="bg-white rounded-lg shadow">
                  <div className="px-6 py-4 border-b border-gray-200">
                    <div className="flex items-center justify-between">
                      <h3 className="text-lg font-semibold text-gray-800">Test Results</h3>
                      <div className="flex items-center space-x-2">
                        <span
                          className={`px-3 py-1 rounded-full text-sm font-medium ${
                            response.success 
                              ? 'bg-green-100 text-green-800' 
                              : 'bg-red-100 text-red-800'
                          }`}
                        >
                          {response.success ? '✅ Success' : '❌ Error'} - {response.status}
                        </span>
                        <span className="text-sm text-gray-500">
                          {response.timing.duration}ms
                        </span>
                      </div>
                    </div>
                  </div>

                  <div className="p-6">
                    <div className="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                      <pre className="text-sm text-gray-800 whitespace-pre-wrap">
                        {JSON.stringify(response.data, null, 2)}
                      </pre>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        };

        const LookerHealthDashboard = () => {
          const [diagnosticResults, setDiagnosticResults] = useState(null);
          const [isRunning, setIsRunning] = useState(false);
          const [selectedTab, setSelectedTab] = useState('two-phase');
          const [error, setError] = useState(null);

          const runDiagnostic = async () => {
            setIsRunning(true);
            setError(null);
            
            try {
              const response = await fetch('/api/diagnostic/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
              });
              
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              
              const data = await response.json();
              
              if (!data || typeof data !== 'object') {
                throw new Error('Invalid response structure from API');
              }
              
              setDiagnosticResults(data);
              
            } catch (error) {
              console.error('Diagnostic failed:', error);
              setError(error.message);
            } finally {
              setIsRunning(false);
            }
          };

          const getSeverityColor = (severity) => {
            switch (severity) {
              case 'critical': return 'bg-red-100 text-red-800';
              case 'high': return 'bg-red-100 text-red-800';
              case 'medium': return 'bg-yellow-100 text-yellow-800';
              case 'low': return 'bg-blue-100 text-blue-800';
              default: return 'bg-gray-100 text-gray-800';
            }
          };

          const HealthMetricCard = ({ title, score = 0, icon: Icon, description }) => (
            <div className={`p-6 rounded-lg border-2 ${score >= 80 ? 'bg-green-100' : score >= 60 ? 'bg-yellow-100' : 'bg-red-100'} border-gray-200`}>
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center space-x-2">
                  <Icon className={`w-5 h-5 ${score >= 80 ? 'text-green-600' : score >= 60 ? 'text-yellow-600' : 'text-red-600'}`} />
                  <h3 className="font-semibold text-gray-700">{title}</h3>
                </div>
                <span className={`text-2xl font-bold ${score >= 80 ? 'text-green-600' : score >= 60 ? 'text-yellow-600' : 'text-red-600'}`}>
                  {score}/100
                </span>
              </div>
              <div className="w-full bg-gray-200 rounded-full h-2">
                <div 
                  className={`h-2 rounded-full ${score >= 80 ? 'bg-green-500' : score >= 60 ? 'bg-yellow-500' : 'bg-red-500'}`}
                  style={{ width: `${score}%` }}
                />
              </div>
              <p className="text-sm text-gray-600 mt-2">{description}</p>
            </div>
          );

          // Tab content components
          const renderTabContent = () => {
            switch (selectedTab) {
              case 'two-phase':
                return <TwoPhaseDiagnosticTab />;

              case 'overview':
                if (!diagnosticResults) return <div className="text-center py-8 text-gray-500">Run a diagnostic to see overview data</div>;
                return (
                  <div className="space-y-8">
                    {/* Health Metrics */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                      <HealthMetricCard
                        title="Performance"
                        score={diagnosticResults.healthMetrics?.performance || 0}
                        icon={Activity}
                        description="Query and system performance"
                      />
                      <HealthMetricCard
                        title="Governance"
                        score={diagnosticResults.healthMetrics?.governance || 0}
                        icon={Shield}
                        description="Data governance and security"
                      />
                      <HealthMetricCard
                        title="Usage"
                        score={diagnosticResults.healthMetrics?.usage || 0}
                        icon={Users}
                        description="User adoption and engagement"
                      />
                      <HealthMetricCard
                        title="Data Quality"
                        score={diagnosticResults.healthMetrics?.dataQuality || 0}
                        icon={Database}
                        description="Data accuracy and consistency"
                      />
                      <HealthMetricCard
                        title="Security"
                        score={diagnosticResults.healthMetrics?.security || 0}
                        icon={Shield}
                        description="Access controls and compliance"
                      />
                    </div>
                  </div>
                );

              case 'api-testing':
                return <APITestingTab />;

              default:
                return <div className="text-center py-8 text-gray-500">Feature coming soon...</div>;
            }
          };

          if (error && !diagnosticResults) {
            return (
              <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                <div className="text-center max-w-md">
                  <AlertTriangle className="w-20 h-20 text-red-500 mx-auto mb-6" />
                  <h1 className="text-2xl font-bold text-gray-800 mb-4">Diagnostic Failed</h1>
                  <p className="text-gray-600 mb-6">{error}</p>
                  <button
                    onClick={runDiagnostic}
                    className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-semibold"
                  >
                    Try Again
                  </button>
                </div>
              </div>
            );
          }

          if (isRunning) {
            return (
              <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                <div className="text-center">
                  <div className="animate-pulse">
                    <Activity className="w-16 h-16 text-blue-500 mx-auto mb-4" />
                  </div>
                  <h2 className="text-2xl font-bold text-gray-800 mb-2">Running Diagnostic</h2>
                  <p className="text-gray-600">Analyzing your Looker instance...</p>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gray-50">
              {/* Header */}
              <div className="bg-white shadow-sm border-b">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-3">
                      <Activity className="w-8 h-8 text-blue-600" />
                      <div>
                        <h1 className="text-2xl font-bold text-gray-800">Looker Health Diagnostic</h1>
                        <p className="text-sm text-gray-600">
                          Enhanced with Two-Phase Analysis & API Testing
                        </p>
                      </div>
                    </div>
                    {diagnosticResults && (
                      <button
                        onClick={runDiagnostic}
                        className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg"
                      >
                        Re-run Full Analysis
                      </button>
                    )}
                  </div>
                </div>
              </div>

              {/* Navigation Tabs */}
              <div className="bg-white border-b">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                  <nav className="flex space-x-8">
                    {[
                      { id: 'two-phase', label: 'Two-Phase Diagnostic', icon: Search },
                      { id: 'overview', label: 'Overview', icon: Activity },
                      { id: 'api-testing', label: 'API Testing', icon: Settings }
                    ].map(({ id, label, icon: Icon }) => (
                      <button
                        key={id}
                        onClick={() => setSelectedTab(id)}
                        className={`flex items-center space-x-2 py-4 border-b-2 ${
                          selectedTab === id 
                            ? 'border-blue-500 text-blue-600' 
                            : 'border-transparent text-gray-500 hover:text-gray-700'
                        }`}
                      >
                        <Icon className="w-4 h-4" />
                        <span>{label}</span>
                      </button>
                    ))}
                  </nav>
                </div>
              </div>

              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                {renderTabContent()}
              </div>

              {/* Footer */}
              <div className="bg-white border-t mt-12">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                  <div className="flex items-center justify-between text-sm text-gray-600">
                    <span>Enhanced with Two-Phase Diagnostics & SQL Optimization</span>
                    <span>Built for Looker Hackathon 2025</span>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<LookerHealthDashboard />);
    </script>
</body>
</html>