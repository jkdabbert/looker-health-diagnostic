<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Looker Health Diagnostic Assistant</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createRoot } = ReactDOM;

        // Simple icon components
        const Activity = ({ className }) => <div className={`${className} flex items-center justify-center`}>📊</div>;
        const AlertTriangle = ({ className }) => <div className={`${className} flex items-center justify-center`}>⚠️</div>;
        const CheckCircle = ({ className }) => <div className={`${className} flex items-center justify-center`}>✅</div>;
        const Clock = ({ className }) => <div className={`${className} flex items-center justify-center`}>⏰</div>;
        const Database = ({ className }) => <div className={`${className} flex items-center justify-center`}>🗄️</div>;
        const TrendingUp = ({ className }) => <div className={`${className} flex items-center justify-center`}>📈</div>;
        const Users = ({ className }) => <div className={`${className} flex items-center justify-center`}>👥</div>;
        const Zap = ({ className }) => <div className={`${className} flex items-center justify-center`}>⚡</div>;
        const Target = ({ className }) => <div className={`${className} flex items-center justify-center`}>🎯</div>;
        const BookOpen = ({ className }) => <div className={`${className} flex items-center justify-center`}>📖</div>;
        const Shield = ({ className }) => <div className={`${className} flex items-center justify-center`}>🛡️</div>;
        const Code = ({ className }) => <div className={`${className} flex items-center justify-center`}>💻</div>;
        const Settings = ({ className }) => <div className={`${className} flex items-center justify-center`}>🔧</div>;
        const Search = ({ className }) => <div className={`${className} flex items-center justify-center`}>🔍</div>;
        const Brain = ({ className }) => <div className={`${className} flex items-center justify-center`}>🤖</div>;

        // Enhanced SQL Comparison Card Component with debugging
        const SQLComparisonCard = ({ analysis }) => {
          const [activeTab, setActiveTab] = useState('issues');

          // Debug logging
          console.log('🔍 SQLComparisonCard received analysis:', analysis);
          console.log('🔍 All available fields:', Object.keys(analysis));
          console.log('🔍 Analysis nested object:', analysis.analysis ? Object.keys(analysis.analysis) : 'no nested analysis');
          console.log('🔍 Full analysis object:', JSON.stringify(analysis, null, 2));

          const getSeverityColor = (severity) => {
            switch (severity?.toLowerCase()) {
              case 'critical': return 'bg-red-100 text-red-800 border-red-200';
              case 'high': return 'bg-red-100 text-red-800 border-red-200';
              case 'medium': return 'bg-yellow-100 text-yellow-800 border-yellow-200';
              case 'low': return 'bg-blue-100 text-blue-800 border-blue-200';
              default: return 'bg-gray-100 text-gray-800 border-gray-200';
            }
          };

          const generateOptimizedSQL = (originalSQL, issues, recommendations) => {
            let optimized = originalSQL || 'SQL not available';
            let comments = [];

            // Add optimization comments based on issues and recommendations
            if (issues && issues.length > 0) {
              issues.forEach((issue, index) => {
                if (issue.type === 'performance' && issue.severity === 'high') {
                  comments.push(`-- CRITICAL ISSUE ${index + 1}: ${issue.description}`);
                  comments.push(`-- Fix: ${issue.recommendation || 'See recommendations tab'}`);
                }
              });
            }

            if (recommendations && recommendations.length > 0) {
              recommendations.forEach((rec, index) => {
                if (rec.type === 'pdt_creation' || rec.title?.includes('PDT')) {
                  comments.push(`-- OPTIMIZATION ${index + 1}: ${rec.title || 'Create PDT'}`);
                  comments.push(`-- Expected improvement: ${rec.expectedImprovement || '70-85%'}`);
                }
              });
            }

            return {
              sql: comments.length > 0 ? comments.join('\n') + '\n\n' + optimized : optimized,
              optimizations: comments
            };
          };

          const generatePDTCode = (analysis) => {
            const modelName = analysis.model || 'your_model';
            const exploreName = analysis.explore || 'your_explore';
            
            return `view: ${exploreName}_optimized_pdt {
  derived_table: {
    sql: 
      SELECT 
        DATE_TRUNC('day', created_at) as date_day,
        user_id,
        category,
        COUNT(*) as event_count,
        SUM(amount) as total_amount,
        AVG(amount) as avg_amount
      FROM \${${exploreName}.SQL_TABLE_NAME}
      WHERE created_at >= CURRENT_DATE - INTERVAL 90 DAY
        AND status = 'complete'
      GROUP BY 1, 2, 3 ;;
    
    datagroup_trigger: ${modelName}_default_datagroup
    distribution_style: even
    sortkeys: ["date_day"]
    
    # This PDT reduces query time from ${analysis.runtime}s to ~2-5s
    # Expected improvement: 85-95%
  }
  
  dimension: date_day {
    type: date
    sql: \${TABLE}.date_day ;;
  }
  
  measure: total_events {
    type: sum
    sql: \${TABLE}.event_count ;;
    label: "Total Events"
  }
}`;
          };

          // Handle both nested analysis and direct properties
          const issues = analysis.analysis?.issues || analysis.issues || [];
          const recommendations = analysis.analysis?.recommendations || analysis.recommendations || [];
          const originalSQL = analysis.analysis?.originalSQL || analysis.originalSQL || analysis.sql || '';
          const runtime = analysis.analysis?.runtime || analysis.runtime || analysis.runtime_seconds || 'N/A';
          
          // Debug the SQL availability
          console.log('🔍 SQL data check (FIXED):', {
            originalSQL: originalSQL ? `${originalSQL.length} chars` : 'missing',
            runtime: runtime,
            foundIn: analysis.analysis?.originalSQL ? 'analysis.analysis.originalSQL' : 
                     analysis.originalSQL ? 'analysis.originalSQL' : 
                     analysis.sql ? 'analysis.sql' : 'nowhere'
          });
          
          const optimizedSQLResult = generateOptimizedSQL(originalSQL, issues, recommendations);

          return (
            <div className="bg-white rounded-lg shadow-lg border border-gray-200 mb-6">
              {/* Header */}
              <div className="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-blue-50">
                <div className="flex items-center justify-between">
                  <h4 className="text-lg font-semibold text-gray-800 flex items-center space-x-2">
                    <Brain className="w-5 h-5 text-purple-600" />
                    <span>AI Analysis: {analysis.slug || analysis.queryId}</span>
                  </h4>
                  <div className="flex items-center space-x-2">
                    <span className="bg-red-100 text-red-800 text-sm px-3 py-1 rounded-full font-medium">
                      {runtime}s runtime
                    </span>
                    {analysis.overallPriority && (
                      <span className={`text-sm px-3 py-1 rounded-full font-medium ${getSeverityColor(analysis.overallPriority)}`}>
                        {analysis.overallPriority} priority
                      </span>
                    )}
                  </div>
                </div>
                <div className="text-sm text-gray-600 mt-1">
                  {analysis.model}.{analysis.explore} • {analysis.dashboard || analysis.dashboard_title || 'No dashboard'}
                </div>
              </div>

              {/* Tab Navigation */}
              <div className="border-b border-gray-200">
                <nav className="flex space-x-8 px-6">
                  {[
                    { id: 'issues', label: '🚨 Issues', count: issues.length },
                    { id: 'recommendations', label: '💡 Recommendations', count: recommendations.length },
                    { id: 'sql-comparison', label: '⚡ SQL Optimization' },
                    { id: 'lookml', label: '🏗️ LookML Code' }
                  ].map((tab) => (
                    <button
                      key={tab.id}
                      onClick={() => setActiveTab(tab.id)}
                      className={`py-4 border-b-2 font-medium text-sm flex items-center space-x-1 ${
                        activeTab === tab.id
                          ? 'border-purple-500 text-purple-600'
                          : 'border-transparent text-gray-500 hover:text-gray-700'
                      }`}
                    >
                      <span>{tab.label}</span>
                      {tab.count !== undefined && (
                        <span className={`text-xs px-2 py-0.5 rounded-full ${
                          activeTab === tab.id ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-600'
                        }`}>
                          {tab.count}
                        </span>
                      )}
                    </button>
                  ))}
                </nav>
              </div>

              {/* Tab Content */}
              <div className="p-6">
                {activeTab === 'issues' && (
                  <div className="space-y-3">
                    <h5 className="font-medium text-gray-700 mb-3">Issues Identified:</h5>
                    {analysis.analysis?.issues && analysis.analysis.issues.length > 0 ? (
                      analysis.analysis.issues.map((issue, i) => (
                        <div key={i} className={`p-4 rounded-lg border ${getSeverityColor(issue.severity)}`}>
                          <div className="font-medium mb-1">
                            {issue.type?.replace(/_/g, ' ').toUpperCase()}: {issue.severity?.toUpperCase()}
                          </div>
                          <div className="text-sm mb-2">{issue.description || issue.issue}</div>
                          <div className="text-sm font-medium">
                            💡 Fix: {issue.recommendation}
                          </div>
                        </div>
                      ))
                    ) : (
                      <div className="text-gray-500 text-center py-4">No specific issues identified by AI</div>
                    )}
                  </div>
                )}

                {activeTab === 'recommendations' && (
                  <div className="space-y-3">
                    <h5 className="font-medium text-gray-700 mb-3">Optimization Recommendations:</h5>
                    {analysis.analysis?.recommendations && analysis.analysis.recommendations.length > 0 ? (
                      analysis.analysis.recommendations.map((rec, i) => (
                        <div key={i} className="p-4 bg-green-50 rounded-lg border border-green-200">
                          <div className="font-medium text-green-800 mb-1">
                            {rec.title || rec.action || rec.recommendation}
                          </div>
                          {rec.expectedImprovement && (
                            <div className="text-sm text-green-700 mb-2">
                              Expected improvement: {rec.expectedImprovement}
                            </div>
                          )}
                          {rec.effort && (
                            <div className="text-sm text-green-600">
                              Implementation effort: {rec.effort}
                            </div>
                          )}
                        </div>
                      ))
                    ) : (
                      <div className="text-gray-500 text-center py-4">No specific recommendations available</div>
                    )}
                  </div>
                )}

                {activeTab === 'sql-comparison' && (
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <h5 className="font-medium text-gray-700">SQL Optimization Comparison</h5>
                      <div className="text-sm text-gray-500">
                        Runtime: {runtime}s → Estimated: 2-5s
                      </div>
                    </div>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                      {/* Original SQL */}
                      <div className="border rounded-lg overflow-hidden">
                        <div className="bg-red-50 px-4 py-2 border-b border-red-200">
                          <h6 className="font-medium text-red-800">🐌 Original SQL ({runtime}s)</h6>
                        </div>
                        <div className="bg-gray-50 p-4 max-h-80 overflow-y-auto">
                          <pre className="text-sm text-gray-800 whitespace-pre-wrap">
                            {originalSQL || 'SQL not available'}
                          </pre>
                        </div>
                      </div>

                      {/* Optimized SQL */}
                      <div className="border rounded-lg overflow-hidden">
                        <div className="bg-green-50 px-4 py-2 border-b border-green-200">
                          <h6 className="font-medium text-green-800">⚡ Optimized SQL (Est. 2-5s)</h6>
                        </div>
                        <div className="bg-gray-50 p-4 max-h-80 overflow-y-auto">
                          <pre className="text-sm text-gray-800 whitespace-pre-wrap">
                            {optimizedSQLResult?.sql || 'Optimization suggestions applied above'}
                          </pre>
                        </div>
                      </div>
                    </div>

                    {/* Key Optimizations */}
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                      <h6 className="font-medium text-blue-800 mb-2">🔧 Key Optimizations Applied:</h6>
                      <ul className="text-sm text-blue-700 space-y-1">
                        <li>• Replace SELECT * with specific columns</li>
                        <li>• Add WHERE clause to limit data scanning</li>
                        <li>• Consider PDT implementation for repeated patterns</li>
                        <li>• Add appropriate indexes for JOIN columns</li>
                        {optimizedSQLResult?.optimizations.map((opt, i) => (
                          <li key={i}>• {opt.replace('--', '').trim()}</li>
                        ))}
                      </ul>
                    </div>
                  </div>
                )}

                {activeTab === 'lookml' && (
                  <div className="space-y-4">
                    <div className="flex items-center justify-between">
                      <h5 className="font-medium text-gray-700">Recommended PDT Implementation</h5>
                      <span className="text-sm bg-purple-100 text-purple-800 px-2 py-1 rounded">
                        85-95% faster
                      </span>
                    </div>
                    
                    <div className="bg-gray-800 rounded-lg overflow-hidden">
                      <div className="bg-gray-700 px-4 py-2">
                        <div className="text-white text-sm font-medium">
                          📄 {analysis.explore || 'optimized'}_pdt.view.lkml
                        </div>
                      </div>
                      <div className="p-4 max-h-96 overflow-y-auto">
                        <pre className="text-green-400 text-sm whitespace-pre-wrap">
                          {generatePDTCode(analysis)}
                        </pre>
                      </div>
                    </div>

                    <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                      <h6 className="font-medium text-yellow-800 mb-2">📋 Implementation Steps:</h6>
                      <ol className="text-sm text-yellow-700 space-y-1 list-decimal list-inside">
                        <li>Create the PDT view file above in your LookML project</li>
                        <li>Add appropriate datagroup triggers for refresh timing</li>
                        <li>Update your explore to use the PDT as the base</li>
                        <li>Deploy and test the optimized performance</li>
                        <li>Monitor query performance improvements</li>
                      </ol>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        };

        // Two-Phase Diagnostic Tab Component
        const TwoPhaseDiagnosticTab = () => {
          const [scanResults, setScanResults] = useState(null);
          const [selectedQueries, setSelectedQueries] = useState(new Set());
          const [phase1Loading, setPhase1Loading] = useState(false);
          const [phase2Loading, setPhase2Loading] = useState(false);
          const [aiAnalysisResults, setAiAnalysisResults] = useState([]);
          const [error, setError] = useState(null);

          const runFastScan = async () => {
            setPhase1Loading(true);
            setError(null);
            setScanResults(null);
            setAiAnalysisResults([]);
            
            try {
              const response = await fetch('/api/diagnostic/scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
              });
              
              const data = await response.json();
              
              if (response.ok) {
                setScanResults(data);
              } else {
                setError(data.error || 'Fast scan failed');
              }
            } catch (error) {
              setError(error.message);
            } finally {
              setPhase1Loading(false);
            }
          };

          const toggleQuery = (queryId) => {
            const newSelected = new Set(selectedQueries);
            if (newSelected.has(queryId)) {
              newSelected.delete(queryId);
            } else {
              newSelected.add(queryId);
            }
            setSelectedQueries(newSelected);
          };

          const selectTop = (n) => {
            if (!scanResults) return;
            // Deduplicate queries before selecting top N
            const uniqueQueries = scanResults.slowQuerySummary.queries
              .filter((query, index, array) => 
                array.findIndex(q => q.query_id === query.query_id) === index
              )
              .sort((a, b) => b.runtime_seconds - a.runtime_seconds)
              .slice(0, n);
            setSelectedQueries(new Set(uniqueQueries.map(q => q.query_id)));
          };

          const analyzeSelectedQueries = async () => {
            if (!scanResults || selectedQueries.size === 0) return;
            
            setPhase2Loading(true);
            const queries = scanResults.slowQuerySummary.queries
              .filter(q => selectedQueries.has(q.query_id));
            
            try {
              console.log('🔍 Sending queries for analysis:', queries.map(q => q.slug));
              
              const response = await fetch('/api/diagnostic/analyze-batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ queries, maxQueries: 10 })
              });
              
              const data = await response.json();
              console.log('📊 Received analysis response:', data);
              
              if (response.ok) {
                console.log('✅ Analysis successful, setting results:', (data.analyses || data.results)?.length || 0, 'analyses');
                // Backend returns data in 'results' field, not 'analyses'
                setAiAnalysisResults(data.results || data.analyses || []);
              } else {
                console.error('❌ Analysis failed:', data.error);
                setError(data.error || 'AI analysis failed');
              }
            } catch (error) {
              console.error('❌ Analysis request failed:', error.message);
              setError(error.message);
            } finally {
              setPhase2Loading(false);
            }
          };

          const getSeverityColor = (severity) => {
            switch (severity?.toLowerCase()) {
              case 'critical': return 'bg-red-100 text-red-800';
              case 'high': return 'bg-red-100 text-red-800';
              case 'medium': return 'bg-yellow-100 text-yellow-800';
              case 'low': return 'bg-blue-100 text-blue-800';
              default: return 'bg-gray-100 text-gray-800';
            }
          };

          const getRuntimeColor = (category) => {
            switch (category) {
              case 'critical': return 'text-red-600 bg-red-50';
              case 'high': return 'text-orange-600 bg-orange-50';
              case 'medium': return 'text-yellow-600 bg-yellow-50';
              default: return 'text-green-600 bg-green-50';
            }
          };

          return (
            <div className="space-y-6">
              {/* Phase 1: Fast Scan */}
              <div className="bg-white rounded-lg shadow">
                <div className="px-6 py-4 border-b border-gray-200">
                  <div className="flex items-center space-x-3">
                    <div className="bg-blue-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">1</div>
                    <div>
                      <h3 className="text-lg font-semibold text-gray-800">Fast Performance Scan</h3>
                      <p className="text-sm text-gray-600">Quickly identify slow queries and performance issues (30-60 seconds)</p>
                    </div>
                  </div>
                </div>
                
                <div className="p-6">
                  <button
                    onClick={runFastScan}
                    disabled={phase1Loading}
                    className="bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center space-x-2"
                  >
                    {phase1Loading ? (
                      <>
                        <div className="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full" />
                        <span>Scanning...</span>
                      </>
                    ) : (
                      <>
                        <Search className="w-4 h-4" />
                        <span>Run Fast Scan</span>
                      </>
                    )}
                  </button>

                  {/* Phase 1 Results */}
                  {scanResults && (
                    <div className="mt-6 space-y-4">
                      {/* Summary Cards */}
                      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div className="bg-gray-50 p-4 rounded-lg text-center">
                          <div className="text-3xl font-bold mb-1">
                            {scanResults.overallGrade}
                          </div>
                          <div className="text-sm text-gray-600">Overall Grade</div>
                        </div>
                        <div className="bg-red-50 p-4 rounded-lg text-center">
                          <div className="text-3xl font-bold text-red-600 mb-1">
                            {scanResults.slowQuerySummary?.totalSlowQueries || 0}
                          </div>
                          <div className="text-sm text-gray-600">Slow Queries</div>
                        </div>
                        <div className="bg-orange-50 p-4 rounded-lg text-center">
                          <div className="text-3xl font-bold text-orange-600 mb-1">
                            {scanResults.slowQuerySummary?.avgRuntime?.toFixed(1) || 0}s
                          </div>
                          <div className="text-sm text-gray-600">Avg Runtime</div>
                        </div>
                        <div className="bg-blue-50 p-4 rounded-lg text-center">
                          <div className="text-3xl font-bold text-blue-600 mb-1">
                            {Math.round(scanResults.scanDuration / 1000)}s
                          </div>
                          <div className="text-sm text-gray-600">Scan Time</div>
                        </div>
                      </div>

                      {/* Immediate Recommendations */}
                      {scanResults.recommendations?.immediate && scanResults.recommendations.immediate.length > 0 && (
                        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                          <h4 className="font-semibold text-yellow-800 mb-2 flex items-center space-x-2">
                            <AlertTriangle className="w-5 h-5" />
                            <span>Immediate Actions Required</span>
                          </h4>
                          {scanResults.recommendations.immediate.map((rec, i) => (
                            <div key={i} className="mb-2 last:mb-0">
                              <div className="font-medium text-yellow-800">{rec.title}</div>
                              <div className="text-sm text-yellow-700">{rec.description}</div>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>

              {/* Phase 2: AI Analysis */}
              {scanResults && (
                <div className="bg-white rounded-lg shadow">
                  <div className="px-6 py-4 border-b border-gray-200">
                    <div className="flex items-center space-x-3">
                      <div className="bg-purple-500 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold">2</div>
                      <div>
                        <h3 className="text-lg font-semibold text-gray-800">AI-Powered Query Analysis</h3>
                        <p className="text-sm text-gray-600">Select specific queries for detailed AI analysis and optimization recommendations</p>
                      </div>
                    </div>
                  </div>
                  
                  <div className="p-6">
                    {/* Selection Controls */}
                    <div className="flex flex-wrap gap-2 mb-4">
                      <button
                        onClick={() => selectTop(3)}
                        className="bg-red-100 hover:bg-red-200 text-red-800 px-3 py-2 rounded text-sm transition-colors flex items-center space-x-1"
                      >
                        <span>🔥</span>
                        <span>Select Top 3 Slowest</span>
                      </button>
                      <button
                        onClick={() => selectTop(5)}
                        className="bg-orange-100 hover:bg-orange-200 text-orange-800 px-3 py-2 rounded text-sm transition-colors flex items-center space-x-1"
                      >
                        <span>⚡</span>
                        <span>Select Top 5</span>
                      </button>
                      <button
                        onClick={() => {
                          // Deduplicate before filtering critical queries
                          const uniqueQueries = scanResults.slowQuerySummary.queries
                            .filter((query, index, array) => 
                              array.findIndex(q => q.query_id === query.query_id) === index
                            );
                          const criticalQueries = uniqueQueries
                            .filter(q => q.runtimeCategory === 'critical');
                          setSelectedQueries(new Set(criticalQueries.map(q => q.query_id)));
                        }}
                        className="bg-red-100 hover:bg-red-200 text-red-800 px-3 py-2 rounded text-sm transition-colors flex items-center space-x-1"
                      >
                        <span>🚨</span>
                        <span>Select Critical Only</span>
                      </button>
                      <button
                        onClick={analyzeSelectedQueries}
                        disabled={selectedQueries.size === 0 || phase2Loading}
                        className="bg-purple-600 hover:bg-purple-700 disabled:bg-purple-400 text-white px-4 py-2 rounded text-sm transition-colors flex items-center space-x-2"
                      >
                        {phase2Loading ? (
                          <>
                            <div className="animate-spin w-3 h-3 border-2 border-white border-t-transparent rounded-full" />
                            <span>Analyzing...</span>
                          </>
                        ) : (
                          <>
                            <Brain className="w-3 h-3" />
                            <span>Analyze Selected ({selectedQueries.size})</span>
                          </>
                        )}
                      </button>
                    </div>

                    {/* Query List */}
                    <div className="space-y-2 max-h-96 overflow-y-auto">
                      {scanResults.slowQuerySummary.queries
                        .sort((a, b) => b.runtime_seconds - a.runtime_seconds)
                        // Deduplicate by query_id to prevent duplicate analysis
                        .filter((query, index, array) => 
                          array.findIndex(q => q.query_id === query.query_id) === index
                        )
                        .map((query, index) => (
                          <div key={`${query.query_id}-${index}`} className="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                            <div className="flex items-center justify-between">
                              <div className="flex items-center space-x-3 flex-1">
                                <input
                                  type="checkbox"
                                  checked={selectedQueries.has(query.query_id)}
                                  onChange={() => toggleQuery(query.query_id)}
                                  className="w-4 h-4 text-purple-600 rounded focus:ring-purple-500"
                                />
                                <div className="flex-1 min-w-0">
                                  <div className="font-medium text-gray-900 truncate">
                                    {query.slug || query.query_id}
                                  </div>
                                  <div className="text-sm text-gray-500">
                                    {query.model}.{query.explore} • {query.dashboard_title || 'No dashboard'} • {query.userl}
                                  </div>
                                </div>
                              </div>
                              <div className="flex items-center space-x-2">
                                <span className={`px-2 py-1 rounded text-sm font-medium ${getRuntimeColor(query.runtimeCategory)}`}>
                                  {query.runtime_seconds.toFixed(1)}s
                                </span>
                                <span className={`px-2 py-1 rounded text-xs ${getSeverityColor(query.optimizationPriority)}`}>
                                  {query.optimizationPriority}
                                </span>
                              </div>
                            </div>
                          </div>
                        ))}
                    </div>
                  </div>
                </div>
              )}

              {/* AI Analysis Results with Enhanced SQL Comparison - This is where the 4-tab display appears! */}
              {aiAnalysisResults.length > 0 && (
                <div className="bg-white rounded-lg shadow">
                  <div className="px-6 py-4 border-b border-gray-200">
                    <h3 className="text-lg font-semibold text-gray-800 flex items-center space-x-2">
                      <Brain className="w-5 h-5 text-purple-600" />
                      <span>AI Analysis Results</span>
                    </h3>
                  </div>
                  
                  <div className="p-6 space-y-6">
                    {/* Summary Stats */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                      <div className="bg-purple-50 p-4 rounded-lg text-center">
                        <div className="text-2xl font-bold text-purple-600">{aiAnalysisResults.length}/2</div>
                        <div className="text-sm text-gray-600">Queries Analyzed</div>
                      </div>
                      <div className="bg-red-50 p-4 rounded-lg text-center">
                        <div className="text-2xl font-bold text-red-600">
                          {aiAnalysisResults.reduce((sum, a) => sum + (a.analysis?.issues?.length || 0), 0)}
                        </div>
                        <div className="text-sm text-gray-600">Issues Found</div>
                      </div>
                      <div className="bg-green-50 p-4 rounded-lg text-center">
                        <div className="text-2xl font-bold text-green-600">
                          {aiAnalysisResults.reduce((sum, a) => sum + (a.analysis?.recommendations?.length || 0), 0)}
                        </div>
                        <div className="text-sm text-gray-600">Recommendations</div>
                      </div>
                      <div className="bg-blue-50 p-4 rounded-lg text-center">
                        <div className="text-2xl font-bold text-blue-600">
                          {aiAnalysisResults.filter(a => a.overallPriority === 'critical').length}
                        </div>
                        <div className="text-sm text-gray-600">Critical Priority</div>
                      </div>
                    </div>

                    {/* Individual Query Results with 4-Tab SQL Comparison */}
                    {aiAnalysisResults.map((result, index) => (
                      <SQLComparisonCard key={index} analysis={result} />
                    ))}
                  </div>
                </div>
              )}

              {/* Error Display */}
              {error && (
                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                  <div className="flex items-center space-x-2">
                    <AlertTriangle className="w-5 h-5 text-red-600" />
                    <div className="font-medium text-red-800">Error</div>
                  </div>
                  <div className="text-red-700 mt-1">{error}</div>
                </div>
              )}
            </div>
          );
        };

        // API Testing Tab Component
        const APITestingTab = () => {
          const [testType, setTestType] = useState('mcp');
          const [toolName, setToolName] = useState('');
          const [apiEndpoint, setApiEndpoint] = useState('');
          const [httpMethod, setHttpMethod] = useState('GET');
          const [testArguments, setTestArguments] = useState('{}');
          const [isLoading, setIsLoading] = useState(false);
          const [response, setResponse] = useState(null);
          const [selectedTab, setSelectedTab] = useState('response');

          const predefinedTests = {
            get_models: {
              testType: 'mcp',
              toolName: 'all_lookml_models',
              arguments: '{}'
            },
            get_specific_model: {
              testType: 'mcp',
              toolName: 'looker_model',
              arguments: '{"lookml_model_name": "looker-malloy-sources"}'
            },
            slow_queries: {
              testType: 'mcp',
              toolName: 'query',
              arguments: JSON.stringify({
                model: "system__activity",
                explore: "history",
                fields: [
                  "query.id",
                  "query.slug", 
                  "history.runtime",
                  "history.created_date",
                  "query.model",
                  "query.explore"
                ],
                filters: {
                  "history.runtime": ">5",
                  "history.created_date": "7 days ago for 7 days",
                  "history.status": "complete"
                },
                sorts: ["history.runtime desc"],
                limit: 10
              }, null, 2)
            },
            projects: {
              testType: 'api',
              apiEndpoint: '/api/4.0/projects',
              httpMethod: 'GET',
              arguments: '{}'
            },
            test_connection: {
              testType: 'mcp',
              toolName: 'list_tools',
              arguments: '{}'
            }
          };

          const loadPredefinedTest = (testKey) => {
            const test = predefinedTests[testKey];
            if (test) {
              setTestType(test.testType);
              setToolName(test.toolName || '');
              setApiEndpoint(test.apiEndpoint || '');
              setHttpMethod(test.httpMethod || 'GET');
              setTestArguments(test.arguments);
            }
          };

          const executeTest = async () => {
            setIsLoading(true);
            setResponse(null);

            const startTime = Date.now();

            try {
              let result;
              
              if (testType === 'mcp') {
                result = await fetch('/api/test-mcp', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    toolName: toolName,
                    arguments: JSON.parse(testArguments || '{}')
                  })
                });
              } else {
                result = await fetch('/api/test-api', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    endpoint: apiEndpoint,
                    method: httpMethod,
                    body: httpMethod !== 'GET' ? JSON.parse(testArguments || '{}') : null
                  })
                });
              }

              const endTime = Date.now();
              const responseData = await result.json();

              setResponse({
                success: result.ok,
                status: result.status,
                data: responseData,
                timing: {
                  duration: endTime - startTime,
                  status: result.status
                },
                request: {
                  type: testType,
                  toolName: toolName,
                  endpoint: apiEndpoint,
                  method: httpMethod,
                  arguments: testArguments
                }
              });
            } catch (error) {
              const endTime = Date.now();
              setResponse({
                success: false,
                status: 'Error',
                data: { error: error.message },
                timing: {
                  duration: endTime - startTime,
                  status: 'Failed'
                },
                request: {
                  type: testType,
                  toolName: toolName,
                  endpoint: apiEndpoint,
                  method: httpMethod,
                  arguments: testArguments
                }
              });
            } finally {
              setIsLoading(false);
            }
          };

          return (
            <div className="space-y-6">
              {/* Header */}
              <div className="bg-white rounded-lg shadow p-6">
                <div className="flex items-center space-x-3 mb-4">
                  <Code className="w-6 h-6 text-blue-600" />
                  <div>
                    <h2 className="text-xl font-bold text-gray-800">API Testing Dashboard</h2>
                    <p className="text-sm text-gray-600">Test and debug your Looker API calls and MCP tools</p>
                  </div>
                </div>

                {/* Quick Test Buttons */}
                <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-3 mb-6">
                  <button
                    onClick={() => loadPredefinedTest('get_models')}
                    className="p-3 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg text-sm text-blue-800 transition-colors"
                  >
                    📋 Get All Models
                  </button>
                  <button
                    onClick={() => loadPredefinedTest('get_specific_model')}
                    className="p-3 bg-green-50 hover:bg-green-100 border border-green-200 rounded-lg text-sm text-green-800 transition-colors"
                  >
                    🎯 Get Specific Model
                  </button>
                  <button
                    onClick={() => loadPredefinedTest('slow_queries')}
                    className="p-3 bg-red-50 hover:bg-red-100 border border-red-200 rounded-lg text-sm text-red-800 transition-colors"
                  >
                    🐌 Slow Queries
                  </button>
                  <button
                    onClick={() => loadPredefinedTest('projects')}
                    className="p-3 bg-purple-50 hover:bg-purple-100 border border-purple-200 rounded-lg text-sm text-purple-800 transition-colors"
                  >
                    📁 Get Projects
                  </button>
                  <button
                    onClick={() => loadPredefinedTest('test_connection')}
                    className="p-3 bg-orange-50 hover:bg-orange-100 border border-orange-200 rounded-lg text-sm text-orange-800 transition-colors"
                  >
                    🔧 Test Connection
                  </button>
                </div>

                {/* Test Form */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Test Type</label>
                    <select
                      value={testType}
                      onChange={(e) => setTestType(e.target.value)}
                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                      <option value="mcp">MCP Tool Call</option>
                      <option value="api">Direct API Call</option>
                    </select>
                  </div>

                  {testType === 'mcp' ? (
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Tool Name</label>
                      <input
                        type="text"
                        value={toolName}
                        onChange={(e) => setToolName(e.target.value)}
                        placeholder="e.g., looker_model, query, all_lookml_models"
                        className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                  ) : (
                    <>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">API Endpoint</label>
                        <input
                          type="text"
                          value={apiEndpoint}
                          onChange={(e) => setApiEndpoint(e.target.value)}
                          placeholder="e.g., /api/4.0/lookml_models"
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-gray-700 mb-2">HTTP Method</label>
                        <select
                          value={httpMethod}
                          onChange={(e) => setHttpMethod(e.target.value)}
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                          <option value="GET">GET</option>
                          <option value="POST">POST</option>
                          <option value="PUT">PUT</option>
                          <option value="DELETE">DELETE</option>
                        </select>
                      </div>
                    </>
                  )}
                </div>

                <div className="mb-4">
                  <label className="block text-sm font-medium text-gray-700 mb-2">Arguments/Body (JSON)</label>
                  <textarea
                    value={testArguments}
                    onChange={(e) => setTestArguments(e.target.value)}
                    placeholder='{"lookml_model_name": "looker-malloy-sources"}'
                    rows={6}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm"
                  />
                </div>

                <button
                  onClick={executeTest}
                  disabled={isLoading}
                  className="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400 text-white px-4 py-3 rounded-lg font-medium transition-colors flex items-center justify-center space-x-2"
                >
                  {isLoading ? (
                    <>
                      <div className="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full" />
                      <span>Executing...</span>
                    </>
                  ) : (
                    <>
                      <Zap className="w-4 h-4" />
                      <span>Execute Test</span>
                    </>
                  )}
                </button>
              </div>

              {/* Response Section */}
              {response && (
                <div className="bg-white rounded-lg shadow">
                  <div className="px-6 py-4 border-b border-gray-200">
                    <div className="flex items-center justify-between">
                      <h3 className="text-lg font-semibold text-gray-800">Test Results</h3>
                      <div className="flex items-center space-x-2">
                        <span
                          className={`px-3 py-1 rounded-full text-sm font-medium ${
                            response.success 
                              ? 'bg-green-100 text-green-800' 
                              : 'bg-red-100 text-red-800'
                          }`}
                        >
                          {response.success ? '✅ Success' : '❌ Error'} - {response.status}
                        </span>
                        <span className="text-sm text-gray-500">
                          {response.timing.duration}ms
                        </span>
                      </div>
                    </div>
                  </div>

                  {/* Response Tabs */}
                  <div className="border-b border-gray-200">
                    <nav className="flex space-x-8 px-6">
                      {['response', 'request', 'timing'].map((tab) => (
                        <button
                          key={tab}
                          onClick={() => setSelectedTab(tab)}
                          className={`py-4 border-b-2 font-medium text-sm ${
                            selectedTab === tab
                              ? 'border-blue-500 text-blue-600'
                              : 'border-transparent text-gray-500 hover:text-gray-700'
                          }`}
                        >
                          {tab.charAt(0).toUpperCase() + tab.slice(1)}
                        </button>
                      ))}
                    </nav>
                  </div>

                  {/* Tab Content */}
                  <div className="p-6">
                    {selectedTab === 'response' && (
                      <div className="bg-gray-50 rounded-lg p-4 max-h-96 overflow-y-auto">
                        <pre className="text-sm text-gray-800 whitespace-pre-wrap">
                          {JSON.stringify(response.data, null, 2)}
                        </pre>
                      </div>
                    )}

                    {selectedTab === 'request' && (
                      <div className="bg-gray-50 rounded-lg p-4">
                        <pre className="text-sm text-gray-800 whitespace-pre-wrap">
{`Request Type: ${response.request.type.toUpperCase()}
${response.request.type === 'mcp' ? 'Tool Name: ' + response.request.toolName : 'Endpoint: ' + response.request.endpoint}
${response.request.type === 'api' ? 'Method: ' + response.request.method : ''}
Arguments/Body:
${response.request.arguments}`}
                        </pre>
                      </div>
                    )}

                    {selectedTab === 'timing' && (
                      <div className="bg-gray-50 rounded-lg p-4">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                          <div className="text-center">
                            <div className="text-2xl font-bold text-blue-600">{response.timing.duration}ms</div>
                            <div className="text-sm text-gray-600">Total Duration</div>
                          </div>
                          <div className="text-center">
                            <div className="text-2xl font-bold text-green-600">
                              {response.timing.duration < 1000 ? 'Fast' : 
                               response.timing.duration < 3000 ? 'Normal' : 'Slow'}
                            </div>
                            <div className="text-sm text-gray-600">Performance</div>
                          </div>
                          <div className="text-center">
                            <div className="text-2xl font-bold text-purple-600">{response.status}</div>
                            <div className="text-sm text-gray-600">Status</div>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>
          );
        };

        const LookerHealthDashboard = () => {
          const [diagnosticResults, setDiagnosticResults] = useState(null);
          const [isRunning, setIsRunning] = useState(false);
          const [selectedTab, setSelectedTab] = useState('two-phase');
          const [error, setError] = useState(null);

          const runDiagnostic = async () => {
            setIsRunning(true);
            setError(null);
            
            try {
              const response = await fetch('/api/diagnostic/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
              });
              
              if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
              }
              
              const data = await response.json();
              
              if (!data || typeof data !== 'object') {
                throw new Error('Invalid response structure from API');
              }
              
              setDiagnosticResults(data);
              
            } catch (error) {
              console.error('Diagnostic failed:', error);
              setError(error.message);
            } finally {
              setIsRunning(false);
            }
          };

          const getSeverityColor = (severity) => {
            switch (severity) {
              case 'critical': return 'bg-red-100 text-red-800';
              case 'high': return 'bg-red-100 text-red-800';
              case 'medium': return 'bg-yellow-100 text-yellow-800';
              case 'low': return 'bg-blue-100 text-blue-800';
              default: return 'bg-gray-100 text-gray-800';
            }
          };

          const HealthMetricCard = ({ title, score = 0, icon: Icon, description }) => (
            <div className={`p-6 rounded-lg border-2 ${score >= 80 ? 'bg-green-100' : score >= 60 ? 'bg-yellow-100' : 'bg-red-100'} border-gray-200`}>
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center space-x-2">
                  <Icon className={`w-5 h-5 ${score >= 80 ? 'text-green-600' : score >= 60 ? 'text-yellow-600' : 'text-red-600'}`} />
                  <h3 className="font-semibold text-gray-700">{title}</h3>
                </div>
                <span className={`text-2xl font-bold ${score >= 80 ? 'text-green-600' : score >= 60 ? 'text-yellow-600' : 'text-red-600'}`}>
                  {score}/100
                </span>
              </div>
              <div className="w-full bg-gray-200 rounded-full h-2">
                <div 
                  className={`h-2 rounded-full ${score >= 80 ? 'bg-green-500' : score >= 60 ? 'bg-yellow-500' : 'bg-red-500'}`}
                  style={{ width: `${score}%` }}
                />
              </div>
              <p className="text-sm text-gray-600 mt-2">{description}</p>
            </div>
          );

          const SQLAnalysisCard = ({ analysis }) => {
            const [showOriginalSQL, setShowOriginalSQL] = useState(false);
            
            return (
              <div className="bg-white rounded-lg shadow p-6 mb-4 border-l-4 border-purple-500">
                <div className="flex items-center justify-between mb-4">
                  <h4 className="text-lg font-semibold text-gray-800 flex items-center space-x-2">
                    <Code className="w-5 h-5 text-purple-600" />
                    <span>Query {analysis.queryId} - Analysis</span>
                  </h4>
                  <div className="flex items-center space-x-2">
                    <span className="bg-red-100 text-red-800 text-sm px-3 py-1 rounded-full">
                      {analysis.runtime}s runtime
                    </span>
                    {analysis.overallPriority && (
                      <span className={`text-sm px-3 py-1 rounded-full ${getSeverityColor(analysis.overallPriority)}`}>
                        {analysis.overallPriority} priority
                      </span>
                    )}
                  </div>
                </div>

                <div className="mb-6">
                  <button
                    onClick={() => setShowOriginalSQL(!showOriginalSQL)}
                    className="flex items-center space-x-2 text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors"
                  >
                    <Database className="w-4 h-4" />
                    <span>{showOriginalSQL ? 'Hide' : 'View'} Original SQL Query</span>
                    <span 
                      className="transform transition-transform duration-200"
                      style={{ transform: showOriginalSQL ? 'rotate(180deg)' : 'rotate(0deg)' }}
                    >
                      ▼
                    </span>
                  </button>
                  
                  {showOriginalSQL && (
                    <div className="mt-3 border rounded-lg overflow-hidden">
                      <div className="bg-gray-800 text-white px-3 py-2 text-sm font-medium">
                        Original SQL Query ({analysis.model || 'Unknown'}.{analysis.explore || 'Unknown'})
                      </div>
                      <div className="bg-gray-50 p-4 max-h-64 overflow-y-auto">
                        <pre className="text-sm text-gray-800 whitespace-pre-wrap">
                          {analysis.sql || analysis.originalSQL || 'SQL query not available'}
                        </pre>
                      </div>
                      {(analysis.dashboard || analysis.user) && (
                        <div className="bg-blue-50 px-3 py-2 text-xs text-blue-700 border-t">
                          {analysis.dashboard && `Dashboard: ${analysis.dashboard}`}
                          {analysis.dashboard && analysis.user && ' | '}
                          {analysis.user && `User: ${analysis.user}`}
                        </div>
                      )}
                    </div>
                  )}
                </div>

                {analysis.issues && analysis.issues.length > 0 && (
                  <div className="mb-4">
                    <h5 className="font-medium text-gray-700 mb-2">Issues Identified:</h5>
                    <ul className="space-y-2">
                      {analysis.issues.map((issue, i) => (
                        <li key={i} className={`p-2 rounded ${getSeverityColor(issue.severity)}`}>
                          <strong>{issue.type.replace(/_/g, ' ').toUpperCase()}:</strong> {issue.description}
                        </li>
                      ))}
                    </ul>
                  </div>
                )}
                
                {analysis.recommendations && analysis.recommendations.length > 0 && (
                  <div className="mb-4">
                    <h5 className="font-medium text-gray-700 mb-2">Recommendations:</h5>
                    <ul className="space-y-2">
                      {analysis.recommendations.map((rec, i) => (
                        <li key={i} className="p-2 bg-green-50 rounded border-l-4 border-green-400">
                          <strong>{rec.type.replace(/_/g, ' ').toUpperCase()}:</strong> {rec.action}
                          <div className="text-sm text-green-700 mt-1">
                            Expected: {rec.expectedImprovement} | Effort: {rec.effort}
                          </div>
                        </li>
                      ))}
                    </ul>
                  </div>
                )}
              </div>
            );
          };

          // Tab content components
          const renderTabContent = () => {
            switch (selectedTab) {
              case 'two-phase':
                return <TwoPhaseDiagnosticTab />;

              case 'overview':
                if (!diagnosticResults) return <div className="text-center py-8 text-gray-500">Run a diagnostic to see overview data</div>;
                return (
                  <div className="space-y-8">
                    {/* Health Metrics */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                      <HealthMetricCard
                        title="Performance"
                        score={diagnosticResults.healthMetrics?.performance || 0}
                        icon={Activity}
                        description="Query and system performance"
                      />
                      <HealthMetricCard
                        title="Governance"
                        score={diagnosticResults.healthMetrics?.governance || 0}
                        icon={Shield}
                        description="Data governance and security"
                      />
                      <HealthMetricCard
                        title="Usage"
                        score={diagnosticResults.healthMetrics?.usage || 0}
                        icon={Users}
                        description="User adoption and engagement"
                      />
                      <HealthMetricCard
                        title="Data Quality"
                        score={diagnosticResults.healthMetrics?.dataQuality || 0}
                        icon={Database}
                        description="Data accuracy and consistency"
                      />
                      <HealthMetricCard
                        title="Security"
                        score={diagnosticResults.healthMetrics?.security || 0}
                        icon={Shield}
                        description="Access controls and compliance"
                      />
                    </div>

                    {/* Summary Stats */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                      <div className="bg-white p-6 rounded-lg shadow">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm font-medium text-gray-600">Slow Queries Found</p>
                            <p className="text-3xl font-bold text-red-600">
                              {diagnosticResults.slowQueryAnalysis?.totalSlowQueries || 0}
                            </p>
                          </div>
                          <div className="text-4xl">🐌</div>
                        </div>
                        <div className="text-xs text-gray-500 mt-2">Queries taking >5 seconds</div>
                      </div>
                      
                      <div className="bg-white p-6 rounded-lg shadow">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm font-medium text-gray-600">AI SQL Analysis</p>
                            <p className="text-3xl font-bold text-purple-600">
                              {diagnosticResults.slowQueryAnalysis?.sqlQueriesAnalyzed || 0}
                            </p>
                          </div>
                          <div className="text-4xl">🤖</div>
                        </div>
                        <div className="text-xs text-gray-500 mt-2">With detailed optimizations</div>
                      </div>

                      <div className="bg-white p-6 rounded-lg shadow">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm font-medium text-gray-600">Potential Speedup</p>
                            <p className="text-3xl font-bold text-green-600">
                              {diagnosticResults.slowQueryAnalysis?.potentialImprovement || 'N/A'}
                            </p>
                          </div>
                          <div className="text-4xl">⚡</div>
                        </div>
                        <div className="text-xs text-gray-500 mt-2">Average improvement estimate</div>
                      </div>

                      <div className="bg-white p-6 rounded-lg shadow">
                        <div className="flex items-center justify-between">
                          <div>
                            <p className="text-sm font-medium text-gray-600">Total Issues</p>
                            <p className="text-3xl font-bold text-orange-600">
                              {diagnosticResults.totalIssuesFound || 0}
                            </p>
                          </div>
                          <div className="text-4xl">⚠️</div>
                        </div>
                        <div className="text-xs text-gray-500 mt-2">Across all categories</div>
                      </div>
                    </div>

                    {/* Enhanced Features Status */}
                    {diagnosticResults.enhancedFeatures && (
                      <div className="bg-white rounded-lg shadow">
                        <div className="px-6 py-4 border-b border-gray-200">
                          <h3 className="text-lg font-semibold text-gray-800">Enhanced Analysis Features</h3>
                          <p className="text-sm text-gray-600">Advanced diagnostic capabilities</p>
                        </div>
                        <div className="p-6">
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                            <div className="text-center">
                              <div className={`text-3xl mb-2 ${diagnosticResults.enhancedFeatures.sqlAnalysis ? 'text-green-500' : 'text-red-500'}`}>
                                {diagnosticResults.enhancedFeatures.sqlAnalysis ? '✅' : '❌'}
                              </div>
                              <div className="text-sm font-medium">SQL Analysis</div>
                              <div className="text-xs text-gray-500">Before/After Code</div>
                            </div>
                            <div className="text-center">
                              <div className={`text-3xl mb-2 ${diagnosticResults.enhancedFeatures.specificRecommendations ? 'text-green-500' : 'text-red-500'}`}>
                                {diagnosticResults.enhancedFeatures.specificRecommendations ? '✅' : '❌'}
                              </div>
                              <div className="text-sm font-medium">Specific Recommendations</div>
                              <div className="text-xs text-gray-500">Actionable optimizations</div>
                            </div>
                            <div className="text-center">
                              <div className={`text-3xl mb-2 ${diagnosticResults.enhancedFeatures.lookmlOptimizations ? 'text-green-500' : 'text-red-500'}`}>
                                {diagnosticResults.enhancedFeatures.lookmlOptimizations ? '✅' : '❌'}
                              </div>
                              <div className="text-sm font-medium">LookML Optimization</div>
                              <div className="text-xs text-gray-500">Aggregate tables & PDTs</div>
                            </div>
                            <div className="text-center">
                              <div className="text-3xl mb-2 text-green-500">✅</div>
                              <div className="text-sm font-medium">MCP Integration</div>
                              <div className="text-xs text-gray-500">Real-time data access</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                );

              case 'query-analysis':
                if (!diagnosticResults) return <div className="text-center py-8 text-gray-500">No analysis data available</div>;
                return (
                  <div className="space-y-6">
                    {diagnosticResults.queryAnalysis && diagnosticResults.queryAnalysis.length > 0 ? (
                      <div className="bg-white rounded-lg shadow">
                        <div className="px-6 py-4 border-b border-gray-200">
                          <h3 className="text-lg font-semibold text-gray-800">SQL Query Analysis</h3>
                          <p className="text-sm text-gray-600">Detailed analysis of slow queries</p>
                        </div>
                        <div className="p-6">
                          {diagnosticResults.queryAnalysis.map((analysis, index) => (
                            <SQLAnalysisCard key={index} analysis={analysis} />
                          ))}
                        </div>
                      </div>
                    ) : (
                      <div className="text-center py-8 text-gray-500">
                        No query analysis available. Run a diagnostic to analyze queries.
                      </div>
                    )}
                  </div>
                );

              case 'issues':
                if (!diagnosticResults || !diagnosticResults.detailedIssues) {
                  return <div className="text-center py-8 text-gray-500">No issues data available</div>;
                }
                return (
                  <div className="bg-white rounded-lg shadow">
                    <div className="px-6 py-4 border-b border-gray-200">
                      <h3 className="text-lg font-semibold text-gray-800">All Issues ({diagnosticResults.totalIssuesFound || 0})</h3>
                    </div>
                    <div className="divide-y divide-gray-200">
                      {diagnosticResults.detailedIssues.length > 0 ? diagnosticResults.detailedIssues.map((issue, index) => (
                        <div key={index} className="p-6">
                          <div className="flex items-start justify-between">
                            <div className="flex-1">
                              <div className="flex items-center space-x-3 mb-2">
                                <span className={`px-2 py-1 text-xs font-medium rounded-full ${getSeverityColor(issue.severity)}`}>
                                  {(issue.severity || 'unknown').toUpperCase()}
                                </span>
                                <span className="text-xs text-gray-500 uppercase tracking-wide">{issue.type || 'general'}</span>
                              </div>
                              <h4 className="font-medium text-gray-900 mb-1">{issue.dashboard || issue.item || 'Unknown'}</h4>
                              <p className="text-sm text-gray-600 mb-2">{issue.issue || 'No description available'}</p>
                              <div className="bg-blue-50 p-3 rounded-md">
                                <p className="text-sm text-blue-800">
                                  <strong>Recommendation:</strong> {issue.recommendation || 'No recommendation available'}
                                </p>
                              </div>
                            </div>
                          </div>
                        </div>
                      )) : (
                        <div className="p-6 text-center text-gray-500">No issues found</div>
                      )}
                    </div>
                  </div>
                );

              case 'recommendations':
                if (!diagnosticResults || !diagnosticResults.aiRecommendations) {
                  return <div className="text-center py-8 text-gray-500">No recommendations available</div>;
                }
                return (
                  <div className="space-y-8">
                    <div className="bg-white rounded-lg shadow">
                      <div className="px-6 py-4 border-b border-gray-200">
                        <h3 className="text-lg font-semibold text-gray-800">Priority Actions</h3>
                      </div>
                      <div className="p-6 space-y-6">
                        {diagnosticResults.aiRecommendations.priorities && diagnosticResults.aiRecommendations.priorities.length > 0 ? 
                          diagnosticResults.aiRecommendations.priorities.map((priority, index) => (
                            <div key={index} className="border-l-4 border-purple-500 pl-6">
                              <div className="flex items-center space-x-2 mb-2">
                                <span className="bg-purple-100 text-purple-800 text-xs font-medium px-2 py-1 rounded-full">
                                  Priority #{priority.priority}
                                </span>
                              </div>
                              <h4 className="text-lg font-semibold text-gray-800 mb-2">{priority.title}</h4>
                              <p className="text-gray-600 mb-3">{priority.description}</p>
                              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                                <div className="bg-green-50 p-3 rounded">
                                  <span className="font-medium text-green-800">Impact:</span>
                                  <span className="ml-1 text-green-700">{priority.estimatedImpact || 'Unknown'}</span>
                                </div>
                                <div className="bg-blue-50 p-3 rounded">
                                  <span className="font-medium text-blue-800">Effort:</span>
                                  <span className="ml-1 text-blue-700">{priority.estimatedEffort || 'Unknown'}</span>
                                </div>
                                <div className="bg-orange-50 p-3 rounded">
                                  <span className="font-medium text-orange-800">Timeline:</span>
                                  <span className="ml-1 text-orange-700">{priority.timeframe || 'Unknown'}</span>
                                </div>
                              </div>
                            </div>
                          )) : (
                            <div className="text-center text-gray-500 py-8">
                              No recommendations available. Run a diagnostic to generate recommendations.
                            </div>
                          )
                        }
                      </div>
                    </div>
                  </div>
                );

              case 'api-testing':
                return <APITestingTab />;

              default:
                return <div className="text-center py-8 text-gray-500">Tab content coming soon...</div>;
            }
          };

          if (error && !diagnosticResults) {
            return (
              <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                <div className="text-center max-w-md">
                  <AlertTriangle className="w-20 h-20 text-red-500 mx-auto mb-6" />
                  <h1 className="text-2xl font-bold text-gray-800 mb-4">Diagnostic Failed</h1>
                  <p className="text-gray-600 mb-6">{error}</p>
                  <button
                    onClick={runDiagnostic}
                    className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-semibold"
                  >
                    Try Again
                  </button>
                </div>
              </div>
            );
          }

          if (isRunning) {
            return (
              <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                <div className="text-center">
                  <div className="animate-pulse">
                    <Activity className="w-16 h-16 text-blue-500 mx-auto mb-4" />
                  </div>
                  <h2 className="text-2xl font-bold text-gray-800 mb-2">Running Diagnostic</h2>
                  <p className="text-gray-600">Analyzing your Looker instance...</p>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gray-50">
              {/* Header */}
              <div className="bg-white shadow-sm border-b">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-3">
                      <Activity className="w-8 h-8 text-blue-600" />
                      <div>
                        <h1 className="text-2xl font-bold text-gray-800">Looker Health Diagnostic</h1>
                        <p className="text-sm text-gray-600">
                          Enhanced with Two-Phase Analysis & API Testing
                        </p>
                      </div>
                    </div>
                    {diagnosticResults && (
                      <button
                        onClick={runDiagnostic}
                        className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg"
                      >
                        Re-run Full Analysis
                      </button>
                    )}
                  </div>
                </div>
              </div>

              {/* Navigation Tabs */}
              <div className="bg-white border-b">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                  <nav className="flex space-x-8">
                    {[
                      { id: 'two-phase', label: 'Two-Phase Diagnostic', icon: Search },
                      // { id: 'overview', label: 'Overview', icon: Activity },
                      { id: 'query-analysis', label: 'BQ Analysis', icon: Code },
                      // { id: 'issues', label: 'Issues', icon: AlertTriangle },
                      // { id: 'recommendations', label: 'Recommendations', icon: Target },
                      { id: 'api-testing', label: 'API Testing', icon: Settings }
                    ].map(({ id, label, icon: Icon }) => (
                      <button
                        key={id}
                        onClick={() => setSelectedTab(id)}
                        className={`flex items-center space-x-2 py-4 border-b-2 ${
                          selectedTab === id 
                            ? 'border-blue-500 text-blue-600' 
                            : 'border-transparent text-gray-500 hover:text-gray-700'
                        }`}
                      >
                        <Icon className="w-4 h-4" />
                        <span>{label}</span>
                      </button>
                    ))}
                  </nav>
                </div>
              </div>

              <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                {renderTabContent()}
              </div>

              {/* Footer */}
              <div className="bg-white border-t mt-12">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                  <div className="flex items-center justify-between text-sm text-gray-600">
                    <span>Enhanced with Two-Phase Analysis & AI-Powered SQL Optimization</span>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<LookerHealthDashboard />);
    </script>
</body>
</html>